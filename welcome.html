<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="color-scheme" content="dark light">
		<link rel="icon" href="assets/pics/logos/hiosbadge.png" type="image/icon type">
		<link rel="stylesheet" href="assets/css/style.css" type="text/css">
		<link rel="stylesheet" href="assets/css/ripple.css" type="text/css">
		<!--link rel="stylesheet" href="assets/css/toplevel.css" type="text/css"-->
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0,0" />
		<title>HiOS | Welcome</title>
		<script src="assets/scripts/links.js"></script>

		<!--Sortable JS -- allows the new widgets (inspiration from Harmony Flutter) to work.-->
		<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
	</head>
	<body>
		<!--The universal background image-->
		<div class="background-wrapper">
			<div class="background-image"></div>
		</div>
		<main class="container mt-4 mb-5">
			<div class="card full">
				<div class="card-body text-start">
					<p class="gradientHeading mb-0" id="greetingHome"></p>
					<p class="gradientHeadingSmall">Welcome to HiOSMobile!</p>
				</div>
			</div>

			<div id="widget-container" class="text-center widget-grid mt-2 mb-4">

				<div data-widget-id="at-a-glance">
					<div class="full card h-100">
						<div class="card-body">
							<h5 class="card-title">At a Glance</h5>
							<div style="box-shadow: 0 5px 5px -5px grey;" class="roundedImage" id="ww_6b591a1444ddd" v='1.20' loc='id' a='{"t":"horizontal","lang":"en","ids":["wl8686"],"cl_bkg":"image","cl_font":"#FFFFFF","cl_cloud":"#FFFFFF","cl_persp":"#81D4FA","cl_sun":"#FFC107","cl_moon":"#FFC107","cl_thund":"#FF5722","sl_sot":"celsius","sl_ics":"one","font":"Arial"}'>Weather for the Following Location: <a href="https://2ua.org/gbr/lancaster/map/" id="ww_6b591a1444ddd_u" target="_blank">Lancaster map, United Kingdom</a></div><script async src="https://srv1.weatherwidget.org/js/?id=ww_6b591a1444ddd"></script>
							
							<h5 class="card-title mt-3">Date</h5>
							<p id="date" class="para"></p>
						</div>
					</div>
				</div>

				<div data-widget-id="quick-notes">
					<div class="full card h-100">
						<div class="card-body">
							<h5 class="card-title">Quick Notes</h5>
							<textarea id="quick-notes-textarea" class="form-control" style="min-height: 150px;" placeholder="Write your quick notes here..."></textarea>
						</div>
					</div>
				</div>
			</div>
			<!Please note, to access staff portal after version 1.1.7, you have to exit fullscreen and go back to the HiOS(tm) Launcher and access the staffportal from there;>
		</main>
		<script src="assets/scripts/background.js"></script>
		<script src="assets/scripts/ripple.js"></script>

		<script>
			// --- Global Functions (from your old script) ---
			function showTutorialDiv () {
				document.getElementById('buttonNotPressed').style.display = "none";
				document.getElementById('buttonPressed').style.display = "block";
				document.getElementById('tutorial').style.display = "block";
			}

			function hideTutorialDiv () {
				document.getElementById('buttonNotPressed').style.display = "block";
				document.getElementById('buttonPressed').style.display = "none";
				document.getElementById('tutorial').style.display = "none";
			}

			// --- Main App Function ---
			function runHiOS() {
				// 1. Greeting/Date Code (from your old script)
				try {
					var myDate = new Date();
					var hrs = myDate.getHours();
					var greet;
					if (hrs < 12) greet = 'Good Morning';
					else if (hrs >= 12 && hrs <= 17) greet = 'Good Afternoon';
					else if (hrs >= 17 && hrs <= 24) greet = 'Good Evening';
					
					document.getElementById('greetingHome').innerHTML = '<b>' + greet + '!</b>';
				
					var n = new Date();
					var y = n.getFullYear();
					var m = n.getMonth() + 1;
					var d = n.getDate();
					document.getElementById("date").innerHTML = d + "/" + m + "/" + y;
				} catch (e) {
					console.error("Error setting date/greeting:", e);
				}

				// 2. Reorderable Widget Code
				try {
					const widgetContainer = document.getElementById('widget-container');
					const notesArea = document.getElementById('quick-notes-textarea');

					// Stops if you forgot to update the HTML
					if (!widgetContainer) {
						console.error("Fatal: 'widget-container' ID not found. Widgets will not load.");
						return; 
					}

					// Define widget-saving function
					function saveWidgetOrder() {
						console.log("Saving widget order...");
						let widgetIDs = [];
						for (const widget of widgetContainer.children) {
							const id = widget.getAttribute('data-widget-id');
							// Only add if ID exists
							if (id) { 
								widgetIDs.push(id);
							}
						}
						localStorage.setItem('hiosWidgetOrder', JSON.stringify(widgetIDs));
						console.log("Order saved:", widgetIDs);
					}

					// Define widget-loading function
					function loadWidgetOrder() {
						const savedOrder = localStorage.getItem('hiosWidgetOrder');
						// Check for null or empty array '[]'
						if (savedOrder && savedOrder.length > 2) { 
							const widgetIDs = JSON.parse(savedOrder);
							console.log("Loading order:", widgetIDs);
							
							widgetIDs.forEach(id => {
								const widget = widgetContainer.querySelector(`[data-widget-id="${id}"]`);
								if (widget) {
									// This moves the widget to the end of the container,
									// in the correct saved order.
									widgetContainer.appendChild(widget);
								}
							});
						}
					}

					// Initialize SortableJS
					/*new Sortable(widgetContainer, {
						animation: 150,
						ghostClass: 'widget-ghost',
						onEnd: saveWidgetOrder // Pass the function reference
					});*/

					// Initialize Notes
					if (notesArea) {
						// Load saved notes
						const savedNotes = localStorage.getItem('hiosQuickNotes');
						if (savedNotes) {
							notesArea.value = savedNotes;
						}
						// Add listener to save notes on change
						notesArea.addEventListener('keyup', () => {
							localStorage.setItem('hiosQuickNotes', notesArea.value);
						});
					}

					// Load the initial order
					//loadWidgetOrder();

				} catch (e) {
					console.error("Error initializing widgets:", e);
				}
			}

			// --- Robust DOM Ready Check ---
			// This replaces the simple 'DOMContentLoaded' listener
			if (document.readyState === 'loading') {
				// Loading hasn't finished yet
				document.addEventListener('DOMContentLoaded', runHiOS);
			} else {
				// `DOMContentLoaded` has already fired, run immediately
				runHiOS();
			}
		</script>
	
		<script src="assets/scripts/bootstrap-shim.js"></script>
</body>
</html>
